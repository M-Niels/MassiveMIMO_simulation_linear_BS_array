import cmath
from math import atan
from numpy.random import rand
import numpy as np
import scipy.signal as signal
import random
import matplotlib.pyplot as plt
import scipy.special as bessel
import functions
import QPSK_generator
import plotly.express as px
import plotly.io as pio
import channel_calculation
import plotly.graph_objects as go
import angular_distribution as ad
import datetime
import plotly
import QAM_generator
from skimage import io
from plotly.subplots import make_subplots

pio.renderers.default = "browser"

'''definitions'''
M = 2
message_bits = np.array(
    [1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1])
signal_wave = QAM_generator.create_QAM_signal(message_bits, 64)
# noise v:
# noise = np.random.normal(0, np.sqrt(0.5), (M,len(signal_wave))) + 1j * np.random.normal(0, np.sqrt(0.5), (M,len(signal_wave)))
# noise x:
noise = None
S = 200
dM = 0.5
resolution = 0.1
aantal_runs = 4
titel = '--M=' + str(M) + '_S=' + str(S) + '_dM=' + str(dM) + '_resolution=' + str(resolution) + '_R=' + str(aantal_runs)
header = '(' + datetime.datetime.now().strftime("%Y-%m-%d_%H:%M") + ')' + titel
print(header)

y_setup = list(range(40000 - int(dM * 100 * M / 2), 40000 - int(dM * 100 * M / 2) + int(dM * 100 * M), int(dM * 100)))
y_setup = [i * 0.010 for i in y_setup]
x_setup = list([0 for i in y_setup])
'''random scatt setup'''
# # place scatterers (random)
# for i in range(S):
#     x_setup.append(random.randint(100000, 700000) / 1000)
#     y_setup.append(random.randint(0, 700000) / 1000)
# # random phase
# random_phases = np.random.random(S) * 2 * np.pi

'''fixed scatt setup'''
# place scatterers (fixed)
x_setup.extend(
    [136.904, 324.208, 372.304, 212.753, 616.319, 513.373, 589.705, 525.047, 484.864, 538.594, 499.258, 110.835,
     115.315, 236.064, 544.383, 66.021, 272.965, 669.449, 122.29, 566.642, 295.405, 114.352, 259.209, 612.662, 203.166,
     90.857, 18.275, 206.37, 231.526, 216.672, 174.079, 242.721, 331.709, 239.248, 122.876, 433.624, 417.855, 585.446,
     682.424, 651.79, 169.733, 284.347, 416.862, 168.557, 328.092, 28.119, 45.147, 617.275, 90.954, 646.08, 337.969,
     471.871, 698.868, 546.794, 274.186, 387.491, 451.741, 88.846, 589.791, 18.122, 356.255, 54.018, 584.868, 337.57,
     434.171, 333.598, 393.49, 269.702, 267.907, 510.373, 112.775, 119.559, 445.755, 519.162, 130.22, 588.997, 520.714,
     454.781, 458.637, 642.786, 325.952, 57.881, 507.118, 247.208, 495.825, 671.144, 40.248, 323.388, 1.025, 221.4,
     447.64, 327.338, 605.968, 371.518, 496.838, 227.601, 647.208, 622.315, 517.802, 63.759, 19.094, 385.701, 549.413,
     570.511, 515.346, 235.257, 137.867, 638.515, 331.698, 680.446, 645.178, 304.417, 680.154, 110.715, 286.047,
     486.166, 487.974, 135.729, 604.651, 568.487, 212.926, 17.506, 271.266, 219.229, 570.959, 596.891, 13.415, 684.413,
     214.72, 563.859, 577.021, 249.689, 321.701, 10.718, 610.002, 353.747, 593.27, 392.984, 388.873, 380.876, 600.803,
     263.679, 325.251, 60.873, 439.202, 400.512, 580.556, 391.437, 549.887, 86.23, 166.866, 515.734, 253.437, 152.785,
     489.748, 694.288, 532.801, 317.6, 50.193, 685.889, 560.875, 161.76, 422.744, 364.383, 554.391, 447.738, 129.043,
     577.847, 689.983, 8.836, 428.706, 335.81, 105.527, 97.203, 571.981, 671.844, 562.973, 221.606, 636.106, 110.035,
     699.176, 277.163, 222.081, 325.943, 285.411, 636.263, 197.87, 416.336, 67.464, 415.67, 291.013, 33.061, 8.918,
     49.858, 328.564, 54.573, 4.344, 50.347, 51.743, 496.179, 367.074, 64.579, 333.207, 656.409, 27.387, 47.638,
     532.379, 165.86, 215.765, 91.726, 135.333, 228.438, 604.363, 134.16, 72.727, 633.675, 272.935, 563.061, 104.248,
     635.887, 2.446, 535.386, 438.3, 194.888, 42.854, 409.752, 329.598, 360.081, 490.211, 231.422, 337.353, 201.797,
     661.326, 40.502, 372.725, 205.558, 554.416, 625.857, 90.783, 596.917, 566.918, 124.526, 550.8, 338.193, 42.292,
     88.566, 573.769, 68.553, 112.874, 97.028, 466.31, 200.83, 18.976, 545.632, 45.346, 0.094, 282.81, 447.611, 316.319,
     560.398, 235.53, 240.622, 566.873, 289.45, 40.713, 28.413, 25.137, 458.19, 404.477, 323.798, 474.824, 215.766,
     13.485, 462.984, 78.914, 118.746, 601.227, 43.007, 501.819, 471.749, 35.439, 87.112, 693.91, 502.595, 462.05,
     172.686, 618.918, 484.401, 62.131, 439.691, 543.779, 322.187, 516.889, 159.758, 393.162, 678.431, 474.206, 348.753,
     258.891, 671.065, 552.634, 441.636, 596.079, 98.259, 37.101, 488.444, 325.822, 626.88, 389.8, 548.068, 659.083,
     146.503, 313.935, 30.201, 393.431, 455.945, 192.804, 125.254, 541.352, 12.559, 84.726, 587.429, 184.954, 401.679,
     97.143, 651.125, 674.624, 209.206, 628.735, 671.423, 458.045, 249.327, 81.821, 144.69, 51.464, 30.813, 534.918,
     228.721, 95.974, 175.725, 522.205, 351.513, 535.366, 624.434, 568.804, 296.052, 97.85, 237.518, 375.766, 682.837,
     240.971, 81.808, 691.311, 617.623, 461.701, 545.279, 433.362, 318.413, 40.574, 627.943, 493.492, 59.65, 402.257,
     474.253, 196.94, 48.395, 574.78, 225.859, 354.207, 47.021, 470.63, 308.343, 671.506, 496.394, 238.423, 119.999,
     427.714, 89.063, 278.972, 574.778, 376.375, 607.685, 622.338, 235.663, 149.953, 69.949, 386.778, 297.638, 255.017,
     387.466, 459.045, 635.096, 655.183, 338.452, 455.4, 137.018, 545.425, 449.75, 517.021, 43.893, 108.885, 152.785,
     493.993, 537.661, 559.509, 358.183, 516.634, 107.621, 346.359, 435.643, 210.503, 313.497, 460.402, 427.947,
     229.205, 595.543, 176.33, 280.388, 591.397, 486.547, 650.703, 440.446, 135.665, 245.497, 125.99, 591.799, 163.427,
     363.518, 31.023, 386.795, 34.271, 157.464, 259.414, 649.807, 440.04, 654.22, 679.197, 624.405, 118.158, 259.204,
     589.181, 261.432, 651.433, 454.975, 248.654, 409.516, 405.541, 362.911, 141.79, 646.825, 553.163, 176.27, 338.022,
     174.474, 62.466, 80.166, 1.662, 541.685, 382.686, 652.131, 86.854, 648.679, 253.423, 614.786, 5.51, 460.175,
     469.066, 58.409, 386.246, 463.714, 86.54, 460.672, 548.995, 63.607, 221.624, 493.55, 204.84, 679.582, 269.726,
     347.996, 568.991, 698.238, 380.927, 696.539, 534.114, 76.426, 496.234, 433.766, 468.687, 269.405, 368.645, 342.771,
     123.369, 362.986, 237.484, 39.134, 523.858, 563.845, 226.828, 152.131, 410.704, 465.316, 610.336, 1.643, 159.716,
     269.198, 451.924, 274.02, 208.46, 463.127, 620.05, 82.754, 235.556, 545.612, 692.432, 525.942, 567.515, 628.756,
     142.38, 416.931, 9.682, 355.944, 452.317, 213.84, 96.103, 28.68, 294.57, 202.264, 372.823, 26.168, 682.238,
     636.673, 651.951, 611.198, 637.095, 668.506, 364.819, 244.448, 169.986, 302.057, 328.655, 137.511, 544.487, 42.146,
     671.245, 598.855, 519.906, 165.888, 449.657, 478.559, 346.12, 312.175, 674.873, 397.358, 202.93, 149.896, 560.757,
     669.873, 277.636, 429.665, 51.083, 64.401, 523.109, 494.169, 238.109, 278.305, 686.836, 525.911, 525.992, 530.726,
     348.717, 698.055, 55.839, 582.527, 532.197, 632.384, 688.333, 584.233, 256.479, 451.483, 440.962, 459.016, 8.501,
     37.502, 2.647, 625.91, 80.601, 534.618, 519.635, 642.368, 152.239, 491.556, 428.26, 132.554, 535.144, 506.652,
     125.692, 332.832, 9.003, 378.662, 665.133, 327.107, 572.812, 491.72, 81.959, 441.653, 342.855, 7.299, 367.383,
     627.269, 8.868, 223.148, 569.975, 211.76, 324.491, 193.638, 571.227, 457.913, 205.653, 445.799, 514.183, 519.01,
     633.577, 376.101, 563.672, 340.407, 367.397, 95.848, 495.849, 20.059, 442.913, 677.953, 162.668, 24.494, 535.09,
     88.732, 507.225, 441.898, 68.511, 143.923, 92.602, 221.153, 406.081, 175.983, 176.566, 97.574, 296.727, 249.642,
     17.155, 656.574, 568.765, 589.541, 327.271, 428.389, 156.569, 429.165, 177.847, 647.341, 99.391, 653.927, 566.099,
     388.814, 450.418, 298.141, 291.211, 177.135, 149.652, 365.211, 201.896, 383.144, 215.076, 150.205, 577.629,
     333.259, 98.335, 434.655, 268.387, 94.523, 336.506, 663.641, 570.508, 520.647, 280.629, 62.942, 92.925, 189.531,
     323.336, 519.824, 565.311, 158.403, 288.919, 203.967, 313.376, 204.614, 656.43, 204.489, 656.561, 600.304, 495.457,
     236.736, 197.117, 320.082, 266.24, 554.2, 6.103, 244.102, 503.773, 430.264, 22.478, 344.352, 376.68, 519.669,
     142.939, 480.018, 531.688, 436.421, 546.312, 239.544, 692.279, 117.822, 87.983, 146.069, 440.225, 453.301, 282.141,
     676.628, 35.22, 625.437, 551.434, 276.971, 634.743, 33.651, 57.985, 394.06, 130.541, 562.422, 421.139, 111.001,
     381.333, 193.494, 421.124, 433.224, 140.294, 674.34, 27.941, 491.561, 467.725, 493.485, 19.771, 27.666, 516.795,
     248.895, 401.39, 429.439, 446.837, 277.137, 125.778, 207.169, 47.774, 333.502, 546.037, 564.353, 133.296, 454.95,
     308.004, 237.793, 101.503, 181.689, 223.549, 176.617, 689.084, 249.535, 626.393, 487.154, 167.202, 320.73, 633.807,
     464.109, 699.312, 631.309, 604.249, 33.871, 515.503, 80.52, 323.995, 192.843, 67.155, 13.507, 68.424, 389.838,
     679.387, 89.367, 168.668, 498.603, 9.498, 206.07, 425.562, 76.794, 424.529, 44.945, 139.041, 474.713, 398.466,
     323.289, 664.261, 534.917, 666.815, 110.289, 543.128, 450.485, 44.323, 640.996, 463.487, 313.09, 468.197, 137.509,
     32.85, 523.862, 397.745, 227.004, 158.747, 385.42, 599.902, 400.779, 231.802, 560.686, 654.022, 307.869, 499.214,
     87.033, 127.571, 484.315, 38.523, 445.737, 220.621, 625.33, 16.318, 24.76, 68.171, 108.338, 102.19, 664.794,
     513.747, 365.313, 445.555, 678.058, 116.667, 264.229, 156.195, 561.312, 548.94, 577.315, 498.289, 312.723, 390.411,
     221.441, 295.409, 160.44, 179.505, 114.77, 544.35, 200.441, 621.258, 85.22, 54.08, 510.711, 111.263, 9.019, 82.333,
     627.064, 508.22, 574.094, 492.062, 305.345, 639.357, 407.679, 585.032, 626.526, 667.121, 238.953, 362.581, 130.56,
     341.909, 17.85, 421.641, 77.899, 692.01, 504.924, 536.67, 499.769, 72.747, 502.766, 75.354, 84.953, 458.402,
     54.036, 151.316, 329.756, 169.11, 553.856, 358.488, 215.333, 198.327, 674.727, 54.952, 341.97, 548.606, 361.305,
     680.474, 293.118, 680.06, 28.598, 181.564, 593.949, 147.439, 398.383, 166.511, 285.656, 19.724, 401.01, 585.226,
     223.169, 104.77, 418.563, 365.063, 214.693, 43.265, 394.913, 539.453, 372.103, 329.001, 626.524, 588.682, 569.43,
     695.742, 650.405, 601.469, 587.919, 295.834, 43.625, 248.535, 642.28, 654.939, 621.497, 168.8, 117.214, 313.133,
     251.267, 264.042, 664.738, 518.861, 275.06, 360.41, 524.216, 524.857, 482.086, 186.342, 201.422, 581.64, 357.524,
     144.191, 69.787, 72.581, 34.855, 147.679, 19.97, 136.061, 477.243, 310.467, 538.869, 255.994, 33.232, 107.357,
     656.498, 61.484, 161.413, 384.746, 339.392, 413.717, 97.307, 329.677, 569.769, 396.569, 307.58, 578.766, 198.618,
     178.094, 453.233, 87.481, 350.801, 300.544, 333.179, 246.252, 46.208, 536.706, 116.112, 236.724, 114.908, 102.1,
     403.057, 261.319])
y_setup.extend(
    [379.033, 672.871, 455.867, 680.98, 42.134, 188.184, 504.89, 634.655, 496.932, 623.65, 247.083, 405.661, 622.491,
     674.211, 86.786, 350.438, 295.366, 460.69, 87.577, 676.61, 179.927, 493.366, 574.442, 574.976, 33.43, 279.476,
     26.987, 479.001, 12.423, 340.564, 586.854, 78.247, 454.672, 177.2, 389.305, 693.428, 123.316, 592.967, 243.087,
     301.146, 162.686, 330.611, 527.285, 397.695, 204.971, 683.649, 514.546, 179.83, 527.03, 644.308, 610.485, 517.692,
     668.405, 247.895, 650.694, 370.607, 468.195, 644.474, 66.135, 578.946, 317.854, 331.506, 2.938, 365.347, 397.012,
     189.649, 351.617, 282.849, 401.48, 422.254, 358.637, 287.527, 201.885, 534.421, 44.407, 611.717, 615.968, 450.467,
     248.975, 273.296, 412.916, 668.351, 391.159, 575.022, 697.618, 250.063, 276.567, 190.568, 479.276, 357.103,
     247.927, 174.511, 670.961, 445.223, 689.219, 543.402, 136.566, 430.415, 617.528, 301.942, 323.91, 558.82, 549.423,
     305.65, 602.868, 327.84, 120.067, 391.551, 210.804, 35.33, 77.674, 277.867, 75.804, 114.333, 687.547, 414.774,
     236.302, 173.579, 243.879, 76.618, 692.939, 177.783, 645.156, 162.495, 498.337, 484.882, 249.909, 0.711, 60.548,
     600.432, 453.15, 399.295, 652.835, 535.07, 642.857, 298.112, 537.415, 409.941, 125.536, 253.23, 515.893, 169.161,
     222.255, 695.336, 81.799, 326.909, 587.759, 79.285, 212.4, 404.79, 673.727, 209.2, 227.512, 245.297, 570.671,
     651.903, 79.56, 321.161, 517.679, 319.292, 545.777, 222.357, 381.239, 522.329, 645.768, 422.09, 122.665, 256.376,
     274.461, 210.604, 11.145, 454.262, 418.332, 614.248, 313.489, 343.883, 5.971, 211.166, 522.504, 103.409, 99.575,
     119.153, 214.799, 6.18, 377.24, 356.881, 615.988, 255.747, 672.505, 358.376, 404.408, 83.711, 655.327, 109.08,
     324.029, 429.56, 683.366, 566.195, 681.026, 286.642, 337.29, 451.697, 665.891, 11.395, 589.074, 509.933, 691.602,
     338.413, 5.855, 543.778, 151.951, 422.031, 442.924, 70.074, 95.297, 603.647, 513.541, 329.0, 564.043, 632.274,
     333.051, 417.54, 685.776, 685.387, 672.418, 403.283, 365.772, 527.438, 459.674, 618.45, 238.611, 18.642, 561.086,
     106.523, 584.787, 243.109, 199.735, 170.417, 91.419, 328.411, 659.457, 138.692, 369.508, 493.629, 696.762, 135.578,
     124.632, 625.847, 257.897, 76.164, 474.704, 224.14, 158.454, 120.834, 301.485, 365.632, 663.201, 428.086, 23.432,
     188.455, 160.51, 639.933, 411.996, 425.464, 20.699, 137.854, 204.234, 82.259, 139.64, 256.857, 95.097, 278.059,
     442.337, 610.335, 354.722, 169.793, 88.636, 398.601, 403.099, 247.207, 297.641, 361.797, 601.661, 412.736, 287.935,
     388.207, 354.615, 467.562, 91.671, 317.675, 5.22, 546.958, 376.913, 292.864, 412.894, 341.552, 589.625, 683.455,
     548.555, 273.375, 508.066, 286.43, 290.563, 218.282, 236.061, 640.923, 671.102, 382.945, 455.867, 117.961, 587.143,
     45.198, 283.656, 625.75, 295.095, 32.268, 574.117, 78.412, 83.288, 255.547, 77.542, 331.729, 120.961, 257.22,
     281.792, 542.58, 72.426, 699.335, 390.324, 575.764, 220.938, 645.482, 390.762, 420.104, 445.308, 422.458, 375.051,
     12.944, 1.284, 197.622, 287.571, 21.117, 585.958, 361.325, 569.287, 172.38, 49.639, 110.89, 572.498, 110.322,
     71.093, 164.27, 225.194, 390.711, 241.713, 670.169, 282.385, 227.257, 167.624, 572.737, 508.877, 179.737, 542.489,
     299.881, 485.292, 342.351, 426.795, 420.921, 244.375, 138.856, 146.126, 505.455, 620.853, 698.542, 465.568,
     518.723, 693.901, 279.365, 441.73, 641.033, 508.19, 590.668, 217.423, 242.385, 233.04, 264.126, 178.144, 313.869,
     25.689, 63.96, 317.551, 189.522, 266.201, 337.021, 552.873, 399.102, 81.933, 588.723, 217.604, 353.474, 368.767,
     573.271, 574.342, 29.681, 96.087, 76.105, 533.156, 161.447, 261.603, 154.78, 4.014, 125.576, 685.963, 173.883,
     175.491, 294.369, 219.493, 209.778, 187.958, 590.472, 567.581, 315.81, 250.341, 185.713, 152.66, 490.621, 487.255,
     674.074, 325.406, 203.521, 89.187, 344.601, 586.892, 40.293, 670.319, 94.169, 691.157, 77.85, 9.144, 151.599,
     499.457, 181.051, 175.801, 69.329, 605.603, 31.039, 555.259, 54.798, 677.438, 123.852, 323.816, 658.617, 100.836,
     588.684, 85.805, 676.345, 216.419, 91.81, 653.208, 260.716, 233.886, 518.327, 193.179, 580.948, 629.847, 649.552,
     377.485, 461.47, 671.851, 347.296, 566.963, 7.269, 296.904, 512.672, 699.289, 236.318, 430.323, 254.619, 401.38,
     234.203, 599.45, 54.813, 667.576, 170.736, 666.918, 446.696, 484.019, 220.415, 524.829, 650.434, 406.922, 464.303,
     648.955, 219.873, 165.524, 388.819, 285.492, 339.886, 178.905, 388.693, 25.404, 227.41, 277.031, 2.179, 304.443,
     365.354, 26.589, 81.233, 683.861, 468.41, 132.489, 372.229, 227.045, 613.419, 439.864, 431.27, 151.778, 407.153,
     423.587, 321.873, 429.841, 289.826, 534.041, 71.045, 664.191, 568.8, 588.603, 609.669, 414.091, 398.59, 353.325,
     642.232, 598.551, 641.154, 438.924, 457.433, 476.993, 3.516, 626.86, 277.667, 526.699, 662.568, 220.757, 13.956,
     315.561, 199.543, 257.348, 570.886, 569.193, 503.752, 645.551, 261.713, 138.453, 251.815, 641.276, 420.998,
     367.472, 213.933, 505.425, 478.826, 618.737, 84.676, 518.992, 61.545, 400.936, 109.091, 336.456, 616.477, 613.228,
     628.439, 51.506, 516.635, 176.583, 262.667, 647.305, 542.458, 567.849, 164.832, 690.385, 398.428, 392.08, 154.69,
     277.992, 691.458, 259.604, 338.931, 290.851, 34.903, 227.043, 37.821, 620.799, 341.729, 505.215, 93.689, 312.42,
     406.645, 183.08, 534.457, 17.891, 296.079, 604.503, 460.578, 250.744, 1.187, 614.587, 526.034, 325.663, 412.263,
     69.153, 318.731, 288.575, 331.601, 615.532, 691.539, 375.523, 259.617, 334.199, 365.063, 403.853, 288.016, 227.18,
     199.978, 432.645, 594.095, 598.482, 450.012, 397.57, 43.755, 174.535, 493.791, 496.013, 262.961, 584.911, 44.731,
     126.6, 25.924, 387.995, 626.333, 511.526, 326.147, 267.118, 555.579, 518.326, 169.681, 215.309, 73.13, 590.239,
     251.118, 376.469, 104.71, 673.334, 455.786, 204.115, 451.908, 483.034, 696.651, 248.963, 510.048, 100.353, 594.959,
     606.561, 299.865, 185.248, 433.199, 462.139, 189.405, 510.681, 637.618, 139.669, 279.819, 24.886, 573.645, 79.358,
     541.197, 26.14, 167.643, 4.973, 499.77, 572.238, 43.604, 241.965, 488.882, 112.385, 215.375, 513.111, 601.035,
     392.227, 126.215, 425.436, 432.649, 264.531, 596.101, 477.794, 142.671, 69.408, 538.077, 657.089, 123.505, 236.113,
     55.033, 526.907, 452.199, 515.517, 542.594, 463.98, 577.251, 236.88, 232.652, 591.296, 67.925, 311.334, 491.839,
     366.169, 419.6, 648.651, 61.084, 345.916, 127.665, 182.819, 145.699, 594.986, 415.486, 214.448, 266.579, 234.294,
     98.067, 591.626, 259.93, 578.894, 666.208, 24.531, 200.317, 611.611, 402.054, 55.641, 639.078, 438.677, 696.168,
     347.291, 186.57, 289.453, 76.392, 361.514, 450.209, 296.281, 642.921, 427.9, 255.155, 370.034, 528.403, 430.76,
     652.924, 604.128, 463.518, 127.647, 101.106, 5.306, 16.512, 432.963, 323.501, 307.036, 663.089, 132.679, 200.948,
     489.765, 410.46, 219.36, 402.406, 679.422, 115.289, 387.936, 226.686, 580.627, 357.337, 637.371, 274.783, 518.625,
     328.152, 94.184, 579.439, 686.824, 377.449, 88.837, 570.82, 531.459, 119.388, 207.512, 696.68, 668.176, 308.43,
     124.058, 465.204, 414.581, 93.088, 359.083, 103.52, 331.486, 511.771, 203.223, 418.745, 474.226, 25.203, 338.822,
     676.44, 575.479, 479.964, 227.907, 666.351, 433.131, 581.641, 0.74, 414.752, 558.96, 345.206, 179.388, 350.544,
     541.547, 60.693, 416.726, 630.949, 163.756, 247.959, 593.454, 601.335, 171.198, 506.955, 358.644, 503.247, 122.846,
     435.054, 656.795, 75.284, 40.506, 303.291, 635.08, 407.682, 533.631, 4.482, 357.788, 440.869, 646.69, 117.445,
     217.118, 268.667, 439.498, 440.381, 163.107, 46.658, 625.538, 82.437, 673.081, 246.818, 274.749, 539.186, 422.519,
     320.578, 612.736, 295.54, 157.775, 254.45, 278.485, 356.627, 468.356, 314.242, 140.312, 526.852, 115.408, 358.416,
     164.696, 466.19, 343.57, 190.226, 73.626, 591.026, 306.666, 105.166, 599.374, 433.018, 511.643, 425.292, 431.143,
     57.027, 31.216, 105.378, 210.894, 618.592, 42.89, 691.146, 599.061, 7.324, 327.25, 287.594, 655.648, 535.092,
     424.668, 385.188, 273.684, 477.785, 543.363, 44.104, 104.879, 546.391, 519.753, 470.535, 160.682, 503.698, 170.607,
     300.36, 20.448, 630.564, 35.45, 169.14, 668.574, 585.276, 672.214, 157.892, 235.547, 479.29, 356.535, 426.157,
     295.532, 651.864, 50.638, 423.855, 384.811, 59.757, 74.069, 395.489, 665.722, 364.454, 675.94, 484.997, 610.04,
     317.067, 265.523, 205.517, 290.653, 150.417, 269.099, 238.041, 576.853, 636.151, 537.983, 639.838, 273.692, 275.23,
     272.056, 225.07, 219.352, 666.58, 425.324, 206.241, 137.564, 432.85, 454.144, 646.294, 295.266, 35.531, 523.965,
     123.428, 559.091, 2.843, 264.27, 387.754, 427.313, 599.264, 165.599, 478.212, 235.026, 73.152, 377.291, 394.087,
     507.458, 499.123, 465.485, 263.652, 356.482, 218.142, 0.226, 343.272, 473.894, 573.173, 325.75, 675.782, 274.672,
     628.342, 322.077, 21.873, 142.144, 20.643, 548.869, 356.868, 148.416, 372.402, 495.626, 58.299, 651.793, 497.18,
     211.462, 43.906, 214.642])
random_phases = [0.05611822, 0.43566513, 0.83744167, 0.7805519, 0.58480271, 0.98632399, 0.21289288, 0.88825089, 0.89471252, 0.83427997,0.78845038, 0.3128224, 0.13673235, 0.70392962, 0.10676477,0.92804575, 0.77477041, 0.69204264, 0.30840359, 0.70426323,0.99239314, 0.12830945, 0.02303761, 0.59198878, 0.0139303,0.67193313, 0.42960773, 0.73948876, 0.10265943, 0.71412981,0.58715803, 0.64117483, 0.98987275, 0.52638028, 0.19009048,0.85406847, 0.99697084, 0.91986392, 0.69590401, 0.78741582,0.55262245, 0.66993345, 0.46476929, 0.07975967, 0.68366236,0.65341863, 0.99545799, 0.73923697, 0.49663295, 0.14540705,0.94225074, 0.91629562, 0.06163607, 0.31173731, 0.38404732,0.42920858, 0.08568909, 0.63929926, 0.69571079, 0.35679112,0.33732748, 0.93427738, 0.08720886, 0.07489865, 0.38708205,0.20333509, 0.30598261, 0.43755, 0.52126149, 0.12248786,0.82630353, 0.04486331, 0.67329838, 0.19651202, 0.81702925,0.40643033, 0.45756734, 0.3546435, 0.83290001, 0.64115585,0.4128956, 0.16231792, 0.55293031, 0.07936797, 0.57266972,0.43556995, 0.88779605, 0.38416812, 0.55177933, 0.80134576,0.96120955, 0.39598014, 0.55703053, 0.31715457, 0.2755024,0.27465744, 0.57144621, 0.03680888, 0.77858364, 0.6445758,0.48576065, 0.85279218, 0.71343879, 0.06143578, 0.79698416,0.70499022, 0.7346376, 0.9808139, 0.8419244, 0.60356538,0.14659023, 0.55406393, 0.51747776, 0.06492984, 0.97759453,0.88470716, 0.66790477, 0.86871431, 0.3098369, 0.01732207,0.832486, 0.02195267, 0.45787201, 0.25457237, 0.87317976,0.48113053, 0.07728467, 0.53516176, 0.87691402, 0.31901427,0.9606729, 0.87093124, 0.82599772, 0.31238568, 0.86188987,0.41232429, 0.51346025, 0.69290827, 0.589703, 0.11602877,0.9376607, 0.09355357, 0.82709098, 0.35494112, 0.8535295,0.20976736, 0.43236686, 0.31192189, 0.0583658, 0.60092217,0.81329817, 0.88703335, 0.24310225, 0.95820501, 0.41391461,0.8309761, 0.49493163, 0.91180181, 0.25513225, 0.04288238,0.00213658, 0.13087853, 0.62489146, 0.32371426, 0.32092686,0.62078732, 0.10494032, 0.52122615, 0.7044578, 0.93632871,0.9037106, 0.45444446, 0.57071333, 0.46483063, 0.69386835,0.70043527, 0.05344983, 0.78680448, 0.08645273, 0.80106818,0.82550493, 0.63075509, 0.06808681, 0.29092075, 0.24740294,0.12848159, 0.88660763, 0.98017541, 0.94921247, 0.96629287,0.93816554, 0.97465697, 0.11063612, 0.72420847, 0.11098571,0.72285507, 0.83547351, 0.60094248, 0.28714812, 0.73278494,0.857276, 0.29242465, 0.48172037, 0.24735069, 0.28198754,0.7659901, 0.61708581, 0.3613735, 0.31247919, 0.15172179,0.36109169, 0.82181439, 0.8820665, 0.26325453, 0.47604018,0.01715241, 0.11457832, 0.87180942, 0.92391596, 0.12604755,0.0154288, 0.0333111, 0.44527411, 0.83457362, 0.66590078,0.18068308, 0.44856497, 0.25636334, 0.95386726, 0.68062703,0.12190918, 0.21707271, 0.62101185, 0.83495504, 0.11588408,0.20640155, 0.88978372, 0.98453291, 0.80785746, 0.08982229,0.34786718, 0.23378679, 0.88423865, 0.6179368, 0.96592027,0.76899012, 0.06609793, 0.68894801, 0.41538421, 0.38487572,0.70489309, 0.81126274, 0.48585147, 0.45915551, 0.10114399,0.10895441, 0.88529921, 0.11736701, 0.63088306, 0.81568947,0.09062932, 0.00106475, 0.02809005, 0.14078203, 0.13141917,0.75838919, 0.91332812, 0.13895342, 0.61410345, 0.32567558,0.35655016, 0.25029589, 0.39117783, 0.04437546, 0.04992325,0.8946942, 0.59456985, 0.21362942, 0.56280241, 0.71469092,0.73335919, 0.26542184, 0.16973036, 0.25235402, 0.2688513,0.94527344, 0.09027511, 0.23025038, 0.20549277, 0.40235719,0.28249545, 0.06480564, 0.85117662, 0.94550364, 0.16250687,0.55976546, 0.30699317, 0.23435153, 0.02915379, 0.61969999,0.38458318, 0.78422174, 0.76516972, 0.23238107, 0.88784612,0.04542595, 0.92319375, 0.55200017, 0.06190055, 0.09290128,0.91389614, 0.0779164, 0.86325163, 0.38036505, 0.53532355,0.3342375, 0.64427826, 0.74732689, 0.6755753, 0.49869146,0.97704051, 0.43253489, 0.8519127, 0.87235818, 0.51242127,0.81040613, 0.78042298, 0.50744561, 0.88145647, 0.35865041,0.13974482, 0.93329779, 0.92599387, 0.96258815, 0.0621183,0.29128182, 0.24511147, 0.07127766, 0.76886231, 0.84594537,0.33681244, 0.65399569, 0.39017183, 0.77869056, 0.82948547,0.14085059, 0.890259, 0.60774298, 0.63867083, 0.06097369,0.75476028, 0.78400877, 0.76913773, 0.74738697, 0.26637277,0.02179153, 0.93286018, 0.70352748, 0.22910974, 0.8072704,0.60586787, 0.03828207, 0.29505837, 0.36617541, 0.79187773,0.60592106, 0.96204551, 0.10583225, 0.3580479, 0.69148724,0.09760451, 0.7581941, 0.84901651, 0.64277722, 0.24965145,0.26092441, 0.50821415, 0.57247826, 0.52401868, 0.58181735,0.52856102, 0.10293431, 0.37763806, 0.69900297, 0.31664085,0.84217329, 0.27563615, 0.76612871, 0.12964449, 0.92044335,0.96391533, 0.51248181, 0.49852073, 0.95636256, 0.51138358,0.2967324, 0.48251211, 0.71593555, 0.07290982, 0.25604541,0.89645711, 0.67102453, 0.54045457, 0.32209054, 0.31752937,0.86501375, 0.77783593, 0.1000935, 0.44627097, 0.65351275,0.68886045, 0.26337907, 0.74935341, 0.67293962, 0.72822559,0.35091786, 0.38834607, 0.26251485, 0.73681474, 0.97876088,0.62012634, 0.67017218, 0.73238011, 0.26732551, 0.60998608,0.09416289, 0.0110021, 0.59937587, 0.70054669, 0.86908333,0.34424995, 0.93067555, 0.0567276, 0.04695297, 0.35450995,0.77996842, 0.36385496, 0.76475693, 0.64965367, 0.44279724,0.38486247, 0.68087067, 0.4309681, 0.35455598, 0.80248598,0.09458051, 0.68946495, 0.96590717, 0.66792569, 0.61045951,0.45191071, 0.44436617, 0.04003207, 0.63754697, 0.54064487,0.21850368, 0.21898398, 0.04014468, 0.7034162, 0.88302645,0.98486437, 0.49786268, 0.51285835, 0.6612078, 0.56787794,0.50721287, 0.19623022, 0.85638691, 0.48618063, 0.18567521,0.88913021, 0.69431064, 0.93382358, 0.67276692, 0.54863178,0.10579433, 0.98286348, 0.35165917, 0.23448677, 0.29648935,0.10789598, 0.49998013, 0.9361374, 0.75317386, 0.43486342,0.80769953, 0.80769388, 0.21807574, 0.71065728, 0.3145199,0.79944788, 0.21436976, 0.35762031, 0.63259239, 0.75828958,0.30457232, 0.80409679, 0.12772526, 0.72852189, 0.28531995,0.53809075, 0.47077106, 0.89844192, 0.09151948, 0.295896,0.06608217, 0.30041084, 0.59264558, 0.18278274, 0.71481017,0.73349423, 0.63910004, 0.1805668, 0.42794294, 0.66640813,0.10011759, 0.8339105, 0.8899515, 0.0204903, 0.83082925,0.16167859, 0.1084775, 0.08764648, 0.04283319, 0.56168718,0.43839174, 0.15378577, 0.57894303, 0.83412371, 0.58554079,0.91285869, 0.45343813, 0.85329645, 0.14302656, 0.44988433,0.4867622, 0.75357062, 0.52176103, 0.5133726, 0.54499947,0.43504809, 0.96107981, 0.04417711, 0.0196092, 0.04109383,0.91570491, 0.12355498, 0.88152901, 0.93166203, 0.63297712,0.79772019, 0.97490328, 0.2464527, 0.51604591, 0.92894091,0.19861353, 0.20755704, 0.40625624, 0.149168, 0.65593418,0.63324095, 0.78998202, 0.75051485, 0.95123914, 0.98196199,0.10278053, 0.94190426, 0.39202465, 0.13520592, 0.22943996,0.94270704, 0.15075147, 0.09564103, 0.20092092, 0.85197965,0.03444406, 0.57425419, 0.57448874, 0.16407501, 0.15468137,0.25195424, 0.67207395, 0.800639, 0.04468875, 0.48668077,0.17931205, 0.68098846, 0.55465569, 0.9636188, 0.00599194,0.34384027, 0.57827374, 0.44672864, 0.01466208, 0.20334486,0.67275521, 0.76163738, 0.32195608, 0.76153517, 0.50600079,0.66014634, 0.85756731, 0.00880733, 0.53660297, 0.87123867,0.76698165, 0.37767577, 0.12434351, 0.70947366, 0.447271,0.50821025, 0.38097231, 0.18152706, 0.68665406, 0.23880804,0.96308565, 0.72520924, 0.1737433, 0.01994009, 0.1577575,0.18259209, 0.71655753, 0.64810776, 0.63843428, 0.68178466,0.753073, 0.69394075, 0.49173586, 0.32589758, 0.09060427,0.61753279, 0.78069734, 0.49450112, 0.25198521, 0.62895277,0.72597254, 0.15455332, 0.7629433, 0.64734588, 0.02746217,0.65400266, 0.61574595, 0.39878742, 0.87404372, 0.06047545,0.81364147, 0.22731861, 0.54995966, 0.5464821, 0.39880774,0.87581717, 0.7005408, 0.17580463, 0.09108557, 0.0336918,0.9846965, 0.80366572, 0.10035151, 0.79445293, 0.50296493,0.71829074, 0.5501811, 0.79924048, 0.91471644, 0.23099974,0.43072984, 0.48501412, 0.97965602, 0.88924545, 0.16575459,0.03751874, 0.69501708, 0.66029445, 0.81478184, 0.45586818,0.18003628, 0.06104158, 0.32815579, 0.88370892, 0.96455002,0.08106909, 0.84131613, 0.95851956, 0.47861126, 0.92377012,0.85697714, 0.82688812, 0.46059535, 0.38269515, 0.53414566,0.4760256, 0.48677947, 0.10277641, 0.77431705, 0.80602077,0.90776698, 0.62437249, 0.59837936, 0.92187428, 0.48972624,0.16347325, 0.93239288, 0.53436321, 0.03909544, 0.90356093,0.00774696, 0.21666649, 0.86130809, 0.42251302, 0.99055218,0.46499285, 0.99107892, 0.79661965, 0.61018298, 0.22696277,0.69064048, 0.17174502, 0.4961765, 0.44929922, 0.79849536,0.61248404, 0.86047777, 0.68834671, 0.17931166, 0.92406998,0.39958129, 0.93410612, 0.27276475, 0.75163789, 0.97138383,0.74627357, 0.17079248, 0.73871989, 0.19846399, 0.52292325,0.0415924, 0.26602402, 0.77551567, 0.84184039, 0.08523323,0.42592545, 0.72509303, 0.24813498, 0.09179675, 0.76155025,0.65764071, 0.67482113, 0.03272824, 0.35398294, 0.16924,0.04916538, 0.76769245, 0.06525553, 0.58112895, 0.41867716,0.04979241, 0.06988181, 0.05894481, 0.13637996, 0.50749872,0.00940988, 0.80220146, 0.49887682, 0.17726638, 0.09781269,0.57137226, 0.21282434, 0.27603366, 0.77620504, 0.53885572,0.98861534, 0.82557043, 0.5237719, 0.72022446, 0.22037382,0.47258302, 0.66282524, 0.72964467, 0.51333454, 0.07664327,0.37108997, 0.02126258, 0.04058917, 0.59714924, 0.62505442,0.52552823, 0.54585957, 0.93317525, 0.7100171, 0.93445153,0.82041482, 0.14225715, 0.97646703, 0.94574407, 0.58013258,0.51736752, 0.34482379, 0.26229635, 0.51470439, 0.85833731,0.24655619, 0.46533712, 0.60916171, 0.51632035, 0.18256433,0.7156256, 0.14056041, 0.47904028, 0.5763794, 0.18573646,0.52828844, 0.93624931, 0.42419151, 0.24382162, 0.10944037,0.37008104, 0.5616106, 0.27581531, 0.76099978, 0.66894628,0.8842965, 0.14958691, 0.77373654, 0.2517328, 0.26487687,0.55077701, 0.48165848, 0.85195934, 0.73442066, 0.42230052,0.87511656, 0.34075427, 0.4925237, 0.71458593, 0.97897412,0.69462974, 0.34151298, 0.35481361, 0.49598947, 0.47202382,0.09774096, 0.18349441, 0.94370245, 0.16848197, 0.08303336,0.64810464, 0.08522701, 0.96265614, 0.01826388, 0.26638955,0.42397384, 0.10592166, 0.57162147, 0.85385624, 0.38289491,0.86274392, 0.25124653, 0.4680087, 0.87085298, 0.01686595,0.62129529, 0.66308038, 0.33846333, 0.69674805, 0.79185675,0.30016012, 0.16582154, 0.34177384, 0.40474822, 0.49714666,0.80699811, 0.5563824, 0.37214899, 0.50430101, 0.73890402,0.0705279, 0.06801757, 0.13410333, 0.65426585, 0.26184745,0.64352034, 0.68305314, 0.04878884, 0.55690808, 0.56699659,0.0372055, 0.13669784, 0.11101834, 0.6909448, 0.06476246,0.97896648, 0.86929492, 0.90931257, 0.57458791, 0.46857193,0.47629876, 0.86039506, 0.51384766, 0.44522409, 0.5639341,0.35592567, 0.39538816, 0.03529208, 0.99023117, 0.10400348,0.51528757, 0.28200507, 0.94161392, 0.73880338, 0.48316527,0.07540438, 0.95638918, 0.14419264, 0.58273835, 0.47633381,0.73750443, 0.61880078, 0.90648933, 0.64564645, 0.06578072,0.75440533, 0.39847912, 0.10303061, 0.81765643, 0.4790099,0.95168607, 0.97719257, 0.64634273, 0.50895458, 0.77893902,0.85570102, 0.23378162, 0.33881269, 0.13095033, 0.93301721,0.62221854, 0.94964839, 0.41096772, 0.17313391, 0.88002917,0.98883134, 0.77868551, 0.28025805, 0.97088778, 0.57959198,0.05787205, 0.50273291, 0.58342041, 0.49323071, 0.73930361,0.32270789, 0.65256522, 0.74109516, 0.75797009, 0.86178508,0.31012871, 0.62488681, 0.03420799, 0.15500381, 0.69907781,0.69203918, 0.05427405, 0.78071248, 0.24478402, 0.0563356,0.6802985, 0.20879766, 0.05472069, 0.98882771, 0.84603348,0.37740309, 0.13827439, 0.09748393, 0.58234602, 0.81766767,0.39610266, 0.19033774, 0.164036, 0.55009339, 0.84050821,0.33580653, 0.29146687, 0.81807037, 0.73472149, 0.80353965,0.34402355, 0.59605975, 0.28211565, 0.98811327, 0.05237239,0.36194079, 0.2451181, 0.29940091, 0.98936832, 0.11020516,0.42140878, 0.86783424, 0.46474922, 0.78143151, 0.22720845]
random_phases = [i*2*np.pi for i in random_phases]


'''fixed UE setup'''
            #    MO     RB       LB      LO       RO      RM      MM       MB      LM
plaatsen_x = [362.319, 595.7, 157.456, 75.149, 635.127, 545.75, 354.62, 365.751, 60.452]
plaatsen_y = [177.642, 559.248, 607.732, 49.53, 99.452, 390.91, 403.956, 617.03, 396.547]
plaatsnaam = ['MO', 'RB', 'LB', 'LO', 'RO', 'RM', 'MM', 'MB', 'LM']
plek = -3
x_setup.append(plaatsen_x[plek])
y_setup.append(plaatsen_y[plek])
pl = ' (' + plaatsnaam[plek] + ')'

'''raster'''
y1 = list(range(-100, 105, 10))
x1 = list(range(-100, 105, 10))
y2 = list(range(-500, -100, 10))
x2 = list(range(-500, -100, 10))
y3 = list(range(110, 510, 10))
x3 = list(range(110, 510, 10))
y2.extend(y1)
y2.extend(y3)
x2.extend(x1)
x2.extend(x3)
y = [item * resolution / 10 + plaatsen_y[plek] for item in y2]
x = [item * resolution / 10 + plaatsen_x[plek] for item in x2]


# calculate distances (a: BS -> scatt; b: scatt -> UE)
distances_a = []  # staat vast, dus moet niet op voorhand gegenereerd worden
for m in range(M):
    distances_a_i = []
    for s in range(S):
        z = s + 2
        distances_a_i.append(np.sqrt((x_setup[m] - x_setup[-z]) ** 2 + (y_setup[m] - y_setup[-z]) ** 2))
    distances_a.append(distances_a_i)
# calc channel vector for UE @original place
h = []
for m in range(M):
    contribution = []
    for s in range(S):
        dist_b = np.sqrt((x_setup[-1] - x_setup[-(s + 2)]) ** 2 + (y_setup[-1] - y_setup[-(s + 2)]) ** 2)
        pathloss = 1/(16 * np.pi**2 * distances_a[m][s] * dist_b)
        phaseshift = 2 * np.pi * (((distances_a[m][s] + dist_b) % 1) + random_phases[s])
        contribution.append(pathloss * np.exp(1j * phaseshift))
    h.append(sum(contribution))
h = np.array(h)
wH = h.conj().T

HDX = []
ampl = np.zeros(shape=(len(x), len(y)))
for a in range(len(y)):
    for b in range(len(x)):
        hdx = []
        for m in range(M):
            contribution = []
            # los_dist = np.sqrt((x[b] - x_setup[m]) ** 2 + (y[a] - x_setup[m]) ** 2)
            # pathloss = 1 / (4 * np.pi * los_dist)
            # phaseshift = 2 * np.pi * (los_dist % 1)
            # contribution.append(pathloss * np.exp(1j * phaseshift))
            for s in range(S):
                dist_b = np.sqrt((x[b] - x_setup[-(s + 2)]) ** 2 + (y[a] - y_setup[-(s + 2)]) ** 2)
                dist = distances_a[m][s] + dist_b
                pathloss = 1 / (16 * np.pi ** 2 * distances_a[m][s] * dist_b)
                phaseshift = 2 * np.pi * ((dist % 1) + random_phases[s])
                contribution.append(pathloss * np.exp(1j * phaseshift))
            hdx.append(sum(contribution))
        HDX.append(hdx)
        desired_signal = np.matmul(wH, hdx) / np.sqrt(M)
        ampl[a, b] = abs(desired_signal)
    print(a)

pl = ' (' + plaatsnaam[plek] + ')'
title = './result plots/' + '(' + datetime.datetime.now().strftime(
    "%Y-%m-%d_%H-%M") + ')-geo_model--M=' + str(M) + '_S=' + str(S) + '_dM=' + str(dM) + '_K=' + str(
    1) + '_resolution=' + str(resolution) + '_middel.html'
functions.plotter(ampl, title, header+'mid', pl, resolution, S, M, x_setup, y_setup, x, y, wH, all_in=True)


UE_quad_x = [np.random.randint(int(len(x)/2), len(x)),
             np.random.randint(0, int(len(x)/2)),
             np.random.randint(0, int(len(x)/2)),
             np.random.randint(int(len(x)/2), len(x))]
UE_quad_y = [np.random.randint(int(len(y)/2), len(y)),
             np.random.randint(int(len(y)/2), len(y)),
             np.random.randint(0, int(len(y)/2)),
             np.random.randint(0, int(len(y)/2))]

gem_ampli = ampl/5
for r in range(aantal_runs):
    hq = np.array(HDX[UE_quad_y[r] * len(y) + UE_quad_x[r]])
    x_setup.append(x[UE_quad_x[r]])
    y_setup.append(y[UE_quad_y[r]])
    wHq = hq.conj().T
    ampl2 = np.zeros(shape=(len(x), len(y)))
    for a in range(len(y)):
        for b in range(len(x)):
            Hdx = np.array(HDX[a * len(y) + b])
            desired_signal = np.matmul(wHq, Hdx) / np.sqrt(M)
            #                  * signal_wave
            # sr = [cmath.polar(i) for i in desired_signal]
            # amplitudes = [item[0] if int(item[1]) == 0 else -item[0] for item in sr]
            # ratio_out_vs_rt_ampl = amplitudes[int(len(amplitudes) / 2) + 1] / signal_wave[int(len(signal_wave) / 2) + 1]
            # if ratio_out_vs_rt_ampl < 0:
            #     ampl[a, b] = -270
            # else:
            ampl2[a, b] = abs(desired_signal)
        print(str(r+1)+'-'+str(a))
    title = './result plots/' + '(' + datetime.datetime.now().strftime(
        "%Y-%m-%d_%H-%M") + ')-geo_model--M=' + str(M) + '_S=' + str(S) + '_dM=' + str(dM) + '_K=' + str(
        1) + '_resolution=' + str(resolution) + '_q' + str(r+1) + '.html'
    functions.plotter(ampl2, title, header+'_q'+str(r+1), pl, resolution, S, M, x_setup, y_setup, x, y, wHq, all_in=True)
    gem_ampli = gem_ampli + ampl2/5


title = './result plots/' + '(' + datetime.datetime.now().strftime("%Y-%m-%d_%H-%M") + ')-geo_model_gem_quad--' + str(M) + '_S=' + str(S) + '_dM=' + str(dM) + '_K=' + str(
        1) + '_resolution=' + str(resolution) + '_gem.html'
functions.plotter(gem_ampli, title, header+'_gem', pl, resolution, S, M, x_setup[:-4], y_setup[:-4], x, y, all_in=False)
